# OpenID connect for Gluu RADIUS

This software allows using OpenID connect to authenticate Cisco ASA in Gluu RADIUS. The web site authenticates in Gluu using OpenID Connect API and requests nonce (generated by `ro_nonce.py` custom script). This is fed into Cisco AnyConnect by redirecting to `anyconnect://` URI with received nonce as password. Cisco ASA then authenticates the user in Gluu RADIUS where another custom script (`ro_check.py`) checks `password` field against saved nonce and authenticates the request if the nonce matches.

## Installation and configuration

It's assumed that Gluu is running with Gluu RADIUS and Cisco ASA is configured to use Gluu RADIUS.

### Gluu configuration
1. Edit `/opt/opendj/config/schema/77-customAttributes.ldif`. Add section:
```
  attributeTypes: ( 1.3.6.1.4.1.39481.1.3.1400 NAME 'radiusNonce'
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.44
  X-ORIGIN 'WWPass - RADIUS Nonce' )
```
Edit line containing `MAY (...)` add `$ radiusNonce` to the list of attributes there.

2. Restart opendj:
```
systemctl restart opendj
```

3. In web admin panel open `Configuration -> Manage Custom scripts -> Dynamic Scopes`. Add new script that is called `ro_nonce`, enabled and contains code from `ro_nonce.py`. Set level to `100` and save it. If you need to limit the use of AnyConnect to certain group, add new property, named `groupDN`. It's value should be the DN of group that will have access.


4. Open `Configuration -> Manage Custom scripts -> Resource Owner Password Credentials`.  Add new script that is called `ro_check`, enabled and contains code from `ro_nonce.py`. Set level to `100` and save it.

5. Open `Configuration -> OpenID Connect -> Scopes`. Add new scope with name `ro_nonce`. Set type to `Dynamic`, check `Allow for dynamic registration`. Press `Add Dynamic Scope Script` and choose `ro_nonce` script from step 3. Save the new scope.

6. Open `Configuration -> OpenID Connect -> Clients`. Use following parameters:
  - Application type: "Web"
  - Subject Type: "pairwise"
  - Authentication method for the Token Endpoint: "client_secret_post"
  - Grant Types: "authorization_code"
  - Pre-authorization and Persist Client Authorizations can be of any value.
  - Scopes: "openid", "user_name", "ro_nonce"
  - Response Types: "code"
  - Redirect Login URIs: "<helper_webapp_base_url>/anyconnect/"

Generate client secret and save the client to get the ID.
Save the secret and clientID values.

### Helper webapp
1. Deploy `webapp.py` and `templates/` to a directory on a web server.
2. Copy `webapp.conf.example` to the web server and rename it to `webapp.conf`
3. Edit `webapp.conf` by filling values relevan to your system. Don't forget to deploy WWPass Connector application and put a link for downloading it in the config.
4. Configure your web server to run `webapp.py --config=webapp.conf` as a demon.
5. Configure your web server software to proxy requests for relevant virtual host to this helper webapp.



